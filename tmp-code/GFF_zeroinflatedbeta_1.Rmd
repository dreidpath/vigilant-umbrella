---
title: "Note on Analysis of IDA Commitments to RMNCAH-N"
author: "Spark Street Consulting"
date: "`r Sys.Date()`"
output: word_document
---

## Environmental setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)  # Generalised framework for data manipiulation in R
library(brms)  # Wrapper for Bayesian analysis using Stan
library(cmdstanr)  # Package for using cmdstanr as the backend Bayesian computational engine

```

## Data setup

Load the GFF data on country-level IDA in general and RMNCAH-N allocations specifically. 

```{r gffdata, echo=false}

# Read in the data
gffDF <- readxl::read_excel("GFF and IDA to RMNCAH-N - Summarized data for FY2011-2023.xlsx", sheet = "Sum data")
# Create an outcome variable (ida_prop) representing the proportion of IDA spending on RMNCAH-N
gffDF$ida_prop <- gffDF$rmnch_total_ida/gffDF$ida_commit
# Create a "treatment" flag representing when GFF funding was used to support RMNCAH-N spending of IDA
gffDF$treatment_flag <- ifelse(gffDF$gff_partnership_date >= gffDF$project_approval_fy, 1, 0)  # Treatment flag
# For analytic purposes, center the `year` variable, setting 2016 as 0
gffDF$year_c <- gffDF$project_approval_fy - 2016
# Turn `country' from a character to a factor
gffDF$country <- as.factor(gffDF$country)
# Remove 59 rows representing a year in which a country had a $0 IDA commitment
gffDF <- gffDF %>% filter(is.finite(ida_prop))

```

Remove undefined values; i.e., the proportion of RMNCAH-N when the IDA commitment is \$0. The logic for this is, if there is a \$0 IDA commitment, then there is no reason to examine the proportion of \$0 that is allocated to RMNCAH-N. Leaving the rows with a $0 IDA commitment in the analysis results in a divide by 0 error.



## Plots proportions

The first plot is the proportions of RMNCAH-N commitments over total IDA commitments for each country (ie., each point). A country will not appear in the plot in any year that the IDA commitments was $0. The values are jittered to avoid points overlapping, and the nature of the GFF partnership is shown.

```{r pressure, echo=FALSE}
# Plot the proportions by country, colored by gff_partner type
p1 <- gffDF %>%
  ggplot(aes(x = jitter(project_approval_fy, .7), y = ida_prop, color = as.factor(gff_partner))) +
     geom_point() +
     labs(
      color = "GFF"  # This changes the title of the legend
     ) +
    scale_color_manual(
    values = c("red", "blue"),
    labels = c("Eligible", "Partner") 
     ) +      
  theme_bw() +
  xlab("Year") +
  ylab("Proportion RMNCHA-N") 

print(p1)

```





# Zero inflated beta regression

When the proportion of the allocation is 1, reduce it to 0.999. There are only `r sum(gffDF$ida_prop == .999)` data points affected. It is done for computational reasons, because in the later beta regression modelling, only values in the range $(0,1)$ are allowed, where $0 < x < 1$.

# Remove rows with divide by zero results in ida_prop and where countries do not receive GFF support
gffDF <- gffDF %>% filter(is.finite(ida_prop), gff_partner == 1)
# Reduce proportionate allocations of 1 to 0.999 for computational reasons 
gffDF$ida_prop[gffDF$ida_prop==1] <- 0.999 



